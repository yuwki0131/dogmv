# Architecture Decision Record (ADR)

## プロジェクト概要

**プロジェクト名**: dogmv (Dog Markdown Viewer)
**目的**: NixOS/Hyprland環境で動作するGUIベースのMarkdownビューアアプリケーション
**決定日**: 2025-10-20

---

## ADR-001: プログラミング言語の選択

### 状況
NixOS/Hyprland（Wayland）環境で動作するGUIアプリケーションを開発する必要がある。

### 決定
**Rust**を採用する。

### 理由
- パフォーマンス重視、メモリ安全性が高い
- Waylandサポートが豊富（wayland-rs等）
- NixOSとの親和性が高い
- GTK4、WebKitGTKのRustバインディングが成熟している

### 影響
- 型安全性によるバグの削減
- コンパイル時の厳密なチェック
- 学習コストはあるが、長期的な保守性が向上

---

## ADR-002: GUIフレームワークの選択

### 状況
Wayland環境でMarkdownをレンダリングするGUIフレームワークが必要。

### 決定
**gtk4-rs** (GTK4のRustバインディング) を採用する。

### 理由
- Waylandネイティブ対応、Hyprlandとの相性良好
- 豊富なウィジェット、成熟したエコシステム
- NixOSでのビルドサポートが充実
- WebKitGTKと連携してWebViewレンダリング可能
- GNOMEベースのデスクトップ環境との統合性が高い

### 代替案
- **Iced**: 純粋Rust実装だが、WebViewサポートが限定的
- **egui**: 軽量だが、Markdownレンダリングを全て自前実装が必要
- **relm4**: gtk4-rsの高レベルラッパーだが、学習コストが二重

### 影響
- GTK4本体の依存が必要（システムライブラリ）
- FFIバインディングのため、純粋なRustではない
- NixOSパッケージングが必要

---

## ADR-003: Markdownパーサーの選択

### 状況
GFM（GitHub Flavored Markdown）対応のパーサーが必要。

### 決定
**comrak**を採用する。

### 理由
- GitHub Flavored Markdown完全対応
- テーブル、タスクリスト、取り消し線など拡張機能豊富
- HTMLへの変換が容易
- シンタックスハイライト用のコールバック対応
- 実績があり、実用的

### 代替案
- **pulldown-cmark**: 高速だがGFM拡張が限定的
- **markdown-rs**: モダンだがエコシステムが小さい

### 影響
- GFM機能がフルに使える
- HTML出力が標準でサポートされている

---

## ADR-004: レンダリング方式の選択

### 状況
MarkdownをHTMLに変換後、どのようにレンダリングするか。

### 決定
**WebView方式（webkit2gtk-rs）**を採用する。

### 理由
- CSSによるスタイリングが容易
- 画像、リンク、テーブルの表示が簡単
- ブラウザと同じ見た目で表示可能
- 開発速度が速い
- GTK4との連携が容易

### 代替案
- **ネイティブウィジェット**: 軽量だが実装が複雑
- **カスタムレンダリング**: 実装コストが極めて高い

### 影響
- WebKitGTKの依存が必須（サイズ大）
- GTK4前提の実装になる

---

## ADR-005: シンタックスハイライトの選択

### 状況
コードブロックのシンタックスハイライトが必要。

### 決定
**syntect**を採用する。

### 理由
- Sublime Textのシンタックス定義（.sublime-syntax）使用
- 200以上の言語サポート
- HTML出力が容易（`<span class="...">`でマークアップ）
- WebViewレンダリングとの相性が良い

### 代替案
- **tree-sitter**: 高速だがHTML変換を自前実装必要
- **highlight.js**: JSに依存、ビルドサイズ増

### 影響
- syntectのシンタックス定義ファイルをバンドル
- HTML生成時にコードブロックを処理

---

## ADR-006: ファイル監視機能

### 状況
外部エディタでMarkdownファイルが変更された際の対応。

### 決定
**notify crateで自動リロード**を実装する。

### 理由
- ライブプレビュー体験の向上
- inotify (Linux) 使用で低オーバーヘッド
- クロスプラットフォーム対応

### 影響
- 非同期タスクでファイル変更監視が必要
- UIへの通知メカニズムが必要

---

## ADR-007: パッケージング方式

### 状況
NixOS環境でのビルド・配布方法。

### 決定
**flake.nix + Cargo.toml (craneを使用)**を採用する。

### 理由
- craneを使用したRustビルドで再現性が高い
- Cargoの依存解決 + Nixの再現性の両立
- 開発環境と配布の両方に対応

### 影響
- flake.nix、shell.nixの作成が必要
- Cargo.toml、Cargo.lockでRust依存管理
- NixOSでのビルドプロセスが標準化

---

## ADR-008: UIレイアウト

### 状況
ファイル選択とプレビュー表示のUI設計。

### 決定
**プレビュー単一画面**を初期実装とする。

### 理由
- シンプルで実装が容易
- Unix哲学（ファイルマネージャと分離）
- 将来的にサイドバー（ファイルツリー）拡張が可能

### 影響
- ファイル選択は`FileChooserDialog`またはCLI引数
- 初期実装ではファイルツリー機能なし

---

## ADR-009: スタイリング方式

### 状況
Markdownの見た目のカスタマイズ方法。

### 決定
**WebView内CSS**を使用する。

### 理由
- HTMLに`<style>`タグでCSS注入可能
- GitHub風スタイルなど選択可能
- カスタマイズ性が高い

### 影響
- CSSテンプレートの作成が必要
- webkit2gtkの`load_html`時にスタイル適用

---

## ADR-010: キーボードショートカット

### 状況
基本的な操作のキーバインド。

### 決定
初期実装では以下のみ実装：
- `Ctrl+O`: ファイルを開く
- `Ctrl+R`: リロード
- `Ctrl+Q`: 終了

### 理由
- 最小限の機能で実装を開始
- 将来的な拡張を想定

### 影響
- GTK4のキーイベントハンドリング実装が必要

---

## ADR-011: パフォーマンス・制約

### 状況
対応するファイルサイズの制限。

### 決定
- **目安**: 2000行（約60KB）
- **平均想定**: 100〜1000行

### 理由
- 実用的なMarkdownファイルサイズ
- WebViewレンダリングの性能制約

### 影響
- 大規模ファイルの最適化は後回し
- 初期実装では仮想スクロール等は実装しない

---

## ADR-012: キャッシュ戦略

### 状況
画像やアセットのキャッシュ。

### 決定
**メモリキャッシュ**を使用する。

### 理由
- シンプルな実装
- ファイルサイズが小さい想定のためディスクキャッシュ不要

### 影響
- WebKitGTK内部のキャッシュメカニズムを利用

---

## ADR-013: CLI引数仕様

### 状況
アプリケーション起動時の引数。

### 決定
- **必須引数**: `dogmv <file.md>`（ファイルパス必須）
- **複数ファイル**: 初期実装では非対応

### 理由
- シンプルな起動方法
- ファイルマネージャから直接開く想定

### 影響
- 引数パースの実装が必要
- 引数なしの場合はエラー

---

## ADR-014: エラーハンドリング

### 状況
各種エラーケースの対応。

### 決定
以下のエラーはログ出力してプロセス終了：
- 存在しないファイル
- Markdown以外のファイル
- 読み込み権限エラー
- 破損データ（UTF-8不正）

**例外**: Markdownフォーマット崩れは生テキストとして表示

### 理由
- シンプルなエラーハンドリング
- ユーザーに明確なフィードバック

### 影響
- エラーメッセージの設計が必要
- ログ出力の実装が必要

---

## ADR-015: 画像パスの解決

### 状況
Markdown内の画像パス（相対パス/絶対パス）の扱い。

### 決定
- **相対パス**: Markdownファイルのディレクトリを基準に解決
- **`<base>`タグ**: 使用して自動解決

### 理由
- 一般的なMarkdownの挙動と一致
- HTMLの`<base>`タグで簡単に実装可能

### 影響
- HTML生成時に`<base href="...">`を追加
- WebViewで`file://`スキームを有効化

---

## ADR-016: ウィンドウ状態の保存

### 状況
ウィンドウサイズ・位置の記憶。

### 決定
**状態保存なし**（デフォルトサイズで起動）

### 理由
- 初期実装の簡素化
- 将来的な拡張は可能

### 影響
- 設定ファイルの読み書き不要
- デフォルトウィンドウサイズの設定が必要

---

## ADR-017: ログ出力

### 状況
デバッグ・エラーログの出力方法。

### 決定
- **ライブラリ**: env_logger + log crate
- **ログレベル**: エラー、警告、情報、デバッグすべて出力
- **出力先**: stdout/stderr

### 理由
- 標準的なRustログエコシステム
- 環境変数`RUST_LOG`で制御可能
- ターミナルで直接確認可能

### 影響
- `env_logger::init()`の初期化が必要
- ログマクロ（`error!`, `warn!`, `info!`, `debug!`）を使用

---

## ADR-018: テスト戦略

### 状況
品質保証のためのテスト。

### 決定
初期実装では**ユニットテスト**のみ実施。

### 理由
- Markdownパース、レンダリングロジックのテストが重要
- GUIテストは難易度が高い

### 影響
- `#[cfg(test)]`モジュールでテスト記述
- `cargo test`で実行可能

---

## ADR-019: CI/CD

### 状況
継続的インテグレーションの設定。

### 決定
初期実装では**手動ビルド**（将来的にGitHub Actions）

### 理由
- 初期実装の簡素化
- ローカル環境での検証優先

### 影響
- GitHub Actionsの設定は後回し
- ローカルでのNixビルド環境が必要

---

## スコープ外（実装しない機能）

以下の機能は初期実装では対象外：

1. **プラグイン機構**: カスタムMarkdown拡張、テーマプラグイン
2. **エクスポート機能**: PDF/HTML出力
3. **複数ファイル対応**: タブ機能、複数ファイルオープン
4. **エディタ機能**: テキスト編集、分割ビュー
5. **CI/CD**: GitHub Actions（将来対応）

---

## システムライブラリ依存（NixOS）

以下のシステムライブラリが必要：

```nix
buildInputs = [
  gtk4
  webkitgtk_6_0
  pkg-config
];
```

**確認事項**:
- GTK4のWaylandバックエンドが有効（NixOSではデフォルト有効）
- `webkitgtk_6_0`の利用（GTK4対応版）
- Hyprland環境変数（`GDK_BACKEND=wayland`）

---

## まとめ

このADRに基づき、以下の技術スタックで実装を進める：

```
言語: Rust
GUIフレームワーク: gtk4-rs
レンダリング: WebView (webkit2gtk-rs)
Markdownパーサー: comrak
シンタックスハイライト: syntect
ファイル監視: notify
パッケージング: flake.nix + Cargo (crane)
ログ: env_logger + log
テスト: ユニットテスト
```

すべての主要なアーキテクチャ決定が文書化され、実装の方針が明確になった。
